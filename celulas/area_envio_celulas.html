<div class='alert alert-primary' role='alert' style='margin-top: 10px;'>
    <div class="alert alert-secondary">
        <span style="font-weight: bold;">Usuário logado: </span><span id="sUsuarioLogado"></span>&nbsp;&nbsp;
        <div class="btn-group" role="group" aria-label="...">
            <button type='button' class='btn btn-primary' data-toggle='modal' data-target='#modalNovaSenha'>Alterar senha</button>
        </div>
    </div>
    <br />
    <div class="form-group">
        <label for="iDescricaoNovaCelula">Descrição da célula:</label>
        <input type="text" class="form-control" id="iDescricaoNovaCelula" aria-describedby="emailHelp">
    </div>
    <br />
    <div class="form-group">
        <label for="iDataNovaCelula">Data da célula:</label>
        <input type="date" id="iDataNovaCelula" class="form-control" aria-label="Livro" aria-describedby="basic-addon1" />
    </div>
    <br />
    <div class="form-group">
        <label for="iFotosCelula">Fotos:</label>
        <input type="file" multiple id="iFotosCelula" class="form-control" />
    </div>
    <button type="button" class="btn btn-primary" id="bEnviar">Enviar</button>
    
    <div class="row" style="margin-top: 10px; display: none;" id="divEnvioFotos">
        <div class="col-12">
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                <div class="progress">
                    <div id="pEnvioFoto" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">0%</div>
                </div>
                <strong style="display: none;" id="sMensagemConcluida">Célula enviada com sucesso!</strong>
                <button type="button" id="bFecharProgresso" class="close" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
            </div>
        </div>
    </div>

    <div id="dCelulasEnviadas">

    </div>
</div>

<!--Modal exibir fotos célula-->
<div class="modal fade" id="modalExibirCelula" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="titleCelula"></h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div id="dFotosCelula">

          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

<script type="text/javascript">

    const firebaseConfig = {
        apiKey: "AIzaSyC_Lz-HIXHPz90MM_8vERto3dUK1rGts44",
        authDomain: "igreja-batista-campos-brancos.firebaseapp.com",
        databaseURL: "https://igreja-batista-campos-brancos-default-rtdb.firebaseio.com",
        projectId: "igreja-batista-campos-brancos",
        storageBucket: "igreja-batista-campos-brancos.appspot.com",
        messagingSenderId: "724470922283",
        appId: "1:724470922283:web:fcf1eaf1f43df1d48dfe6e",
        measurementId: "G-WKZFS0PDDY"
    };

    if(!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }

    const auth = firebase.auth();
    const provider = new firebase.auth.GoogleAuthProvider();
    const db = firebase.firestore();
    const storage = firebase.storage();

    function formatarData(data){
        let split = data.split("-");
        return split[2] + "/" + split[1] + "/" + split[0];
    }

    function exibirFotosCelula(id){
        $("#dFotosCelula").html("<h5>Carregando célula...</h5>");

        db.collection("celulas").get("dFotosCelula").then((data) => {
            $("#titleCelula").text(data.docs[0].data().descricao + " (" + formatarData(data.docs[0].data().data_celula) + ")");
            let idCelula = data.docs[0].data().id;

            db.collection("celulas_fotos").where("id_celula", "==", idCelula).get().then((dataFotos) => {

                $carousel = '<div id="carouselFotosCelula" class="carousel slide" data-ride="carousel">';
                $carousel += '<ol class="carousel-indicators">';
                
                for(var i in dataFotos.docs){
                    $carousel += '<li data-target="#carouselFotosCelula" data-slide-to="' + i + '"';
                    if(i == 0) $carousel += ' class="active"';
                    $carousel += '></li>';
                }

                $carousel += '</ol>';
                $carousel += '<div class="carousel-inner">';
                
                for(var i in dataFotos.docs){
                    $carousel += '<div class="carousel-item';
                    if(i == 0) $carousel += ' active';
                    $carousel += '>';
                    $carousel += '<img class="d-block w-100" src="' + dataFotos.docs[i].data().url_foto + '" />';
                    $carousel += '</div>';
                }

                $carousel += '</div>'; //div carousel-inner
                
                $carousel += '<a class="carousel-control-prev" href="#carouselFotosCelula" role="button" data-slide="prev">';
                $carousel += '<span class="carousel-control-prev-icon" aria-hidden="true"></span>';
                $carousel += '<span class="sr-only">Previous</span>';
                $carousel += '</a>';
                $carousel += '<a class="carousel-control-next" href="#carouselFotosCelula" role="button" data-slide="next">';
                $carousel += '<span class="carousel-control-next-icon" aria-hidden="true"></span>';
                $carousel += '<span class="sr-only">Next</span>';
                $carousel += '</a>';
                
                $carousel += '</div>'; //div carousel

                $("#dFotosCelula").html($carousel);
            });
        });
    }

    function excluirCelula(id){
        console.log("Excluir célula: " + id);
    }

    function uploadImagem(foto, contFotos, contCelulas, tipoArquivo){

        const uploadTask = storage.ref(`celulas/arquivo-${contFotos}`).put(foto);

        uploadTask.on('state_change', (snapshot) => {
            /*let progress = (snapshot.bytesTransferred/snapshot.totalBytes) * 100;
            $("#pEnvioArquivo").val(progress);
            $("#sPorcentagemEnvio").text(Math.round(progress) + "%");*/
        }, (error) =>{
            console.log(error);
        }, () => {
            uploadTask.snapshot.ref.getDownloadURL().then((url) =>{
                db.collection("celulas_fotos").add({
                    id_celula: contCelulas,
                    url_foto: url,
                    tipo_arquivo: tipoArquivo
                });

                let ariaValueNow = Number($("#pEnvioFoto").attr("aria-valuenow"));
                let ariaValueMax = Number($("#pEnvioFoto").attr("aria-valuemax"));

                ariaValueNow += 1;

                $("#pEnvioFoto").attr("aria-valuenow", ariaValueNow);

                let progresso = Number(Number(ariaValueNow) / Number(ariaValueMax)) * 100;

                $("#pEnvioFoto").css("width", progresso + "%");
                $("#pEnvioFoto").text(Math.round(progresso) + "%");

                if(Math.round(progresso) == 100){
                    $("#sMensagemConcluida").show('fade');
                }
            });
        });
    }

    $(function(){

        $("#sUsuarioLogado").text($("#iUsuarioLogado").val());

        db.collection("celulas").where("enviado_por", "==", $("#iUsuarioLogado").val()).onSnapshot((data) => {
            $("#dCelulasEnviadas").html("");

            data.docs.map((val) => {
                let $celula = "<div class='alert alert-success' style='margin-top: 10px;'>";
                $celula += "<b>" + val.data().descricao + "</b> <i>" + formatarData(val.data().data_celula) + "</i>";
                $celula += "&nbsp;";
                $celula += "<button class='btn btn-outline-warning' data-toggle='modal' data-target='#modalExibirCelula' onclick='exibirFotosCelula(\"" + val.id + "\")'>Exibir fotos</button>";
                $celula += "&nbsp;";
                $celula += "<button class='btn btn-outline-danger' onclick='excluirCelula(\"" + val.id + "\")'>Excluir</button>";
                $celula += "</div>";

                $("#dCelulasEnviadas").append($celula);
            });

        });

        $("#bEnviar").click(async () => {
            if($("#iDescricaoNovaCelula").val() == ''){
                alert("Insira uma descrição para a célula!");
            }else if($("#iDataNovaCelula").val() == ''){
                alert("Insira uma data válida!");
            }else if($("#iFotosCelula")[0].files.length == 0){
                alert("Selecione ao menos 1 foto!");
            }else{

                let arquivos = $("#iFotosCelula")[0].files;
                let descricaoCelula = $("#iDescricaoNovaCelula").val();
                let dataCelula = $("#iDataNovaCelula").val();
                let usuarioLogado = $("#iUsuarioLogado").val();

                var patternVideos = /video-*/;

                for(var i=0; i<arquivos.length; i++){
                    if(!arquivos[i].type.includes('image') && !arquivos[i].type.match(patternVideos)){
                        alert("Somente arquivos de imagem e vídeo são permitidos!");
                        return;
                    }
                }

                $("#pEnvioFoto").attr("aria-valuenow", "0");
                $("#pEnvioFoto").css("width", "0%");
                $("#pEnvioFoto").text("0%");
                $("#sMensagemConcluida").hide();
                $("#divEnvioFotos").show();

                db.collection("cont_celulas").get("9GYvhjPyNi6h3m4YV0a1").then(async (data) => {

                    let contCelulas = data.docs[0].data().cont_celulas;
                    let contFotos = data.docs[0].data().cont_fotos;
                    $("#pEnvioFoto").attr("aria-valuemax", arquivos.length);
                    $("#divEnvioFotos").show('fade');

                    db.collection("celulas").add({
                        id: contCelulas,
                        descricao: descricaoCelula,
                        data_celula: dataCelula,
                        enviado_por: usuarioLogado
                    });

                    for(var i=0; i<arquivos.length; i++){
                        if(arquivos[i].type.includes('image')){
                            await uploadImagem(arquivos[i], contFotos, contCelulas, 'imagem');
                        }else{
                            await uploadImagem(arquivos[i], contFotos, contCelulas, 'video');
                        }
                        contFotos++;
                    }

                    db.collection("cont_celulas").doc("9GYvhjPyNi6h3m4YV0a1").update({cont_celulas: ++contCelulas});
                    db.collection("cont_celulas").doc("9GYvhjPyNi6h3m4YV0a1").update({cont_fotos: contFotos});

                    $("#iDescricaoNovaCelula").val("");
                    $("#iDataNovaCelula").val("");
                    $("#iFotosCelula").val("");
                });
            }
        });

        $("#bFecharProgresso").click(function(){
            $("#divEnvioFotos").hide('fade');
            $("#sMensagemConcluida").hide();
            $("#pEnvioFotos").attr("max", 100);
            $("#pEnvioFotos").val(0);
        });
    });
</script>
